CREATE OR REPLACE FUNCTION create_or_update_equipo(id_eq int8, nombre_eq varchar(255), categoria_eq varchar(255),descripcion_eq varchar(255),precio_unitario_eq float8, marca_eq varchar(255),observacion_eq varchar(255), estado_eq enum_equipos_estado, stock_eq integer) RETURNS boolean AS
$$
DECLARE
	stock_actual integer:=0;
	exist_insumos integer:=0;
	exist_instrumentos integer:=0;
	sum_existen integer = 0;
BEGIN
	Select count(id_producto) INTO exist_insumos FROM insumos WHERE id_producto=id_eq;
	Select count(id_producto) INTO exist_instrumentos FROM instrumentos WHERE id_producto=id_eq;
	sum_existen:=exist_insumos+exist_instrumentos;
	IF sum_existen = 0 THEN
		SELECT stock INTO stock_actual FROM equipos WHERE id_producto = id_eq;
		INSERT INTO productos (id, nombre, descripcion, precio_unitario, categoria, fecha_creacion, fecha_actualizacion) 
		VALUES (id_eq, nombre_eq, descripcion_eq, precio_unitario_eq, 'Equipo',CURRENT_DATE,CURRENT_DATE)
		ON CONFLICT (id) DO UPDATE 
  		SET nombre = nombre_eq, descripcion = descripcion_eq,precio_unitario=precio_unitario_eq,categoria='Equipo', fecha_actualizacion= CURRENT_DATE;
			
		INSERT INTO equipos (id_producto, marca, observacion, estado, stock) 
		VALUES (id_eq, marca_eq, observacion_eq, estado_eq, stock_eq)
		ON CONFLICT (id_producto) DO UPDATE 
  		SET marca = marca_eq, observacion = observacion_eq, estado=estado_eq, stock=stock_actual+stock_eq;
		RETURN TRUE;
	ELSE
		RETURN FALSE;
	END IF;
end;
$$ language plpgsql;


CREATE OR REPLACE FUNCTION create_or_update_insumo(id_in int8, nombre_in varchar(255), descripcion_in varchar(255),precio_unitario_in float8, categoria_in varchar(255),fecha_caducidad_in date, stock_in integer) RETURNS boolean AS
$$
DECLARE
	stock_actual integer:=0;
	exist_equipos integer:=0;
	exist_instrumentos integer:=0;
	sum_existen integer = 0;
BEGIN
	Select count(id_producto) INTO exist_equipos FROM equipos WHERE id_producto=id_in;
	Select count(id_producto) INTO exist_instrumentos FROM instrumentos WHERE id_producto=id_in;
	sum_existen:=exist_equipos+exist_instrumentos;
	IF sum_existen = 0 THEN
		SELECT stock INTO stock_actual FROM insumos WHERE id_producto = id_in;
		INSERT INTO productos (id, nombre, descripcion, precio_unitario, categoria, fecha_creacion, fecha_actualizacion ) 
		VALUES (id_in, nombre_in, descripcion_in, precio_unitario_in, 'Insumo',CURRENT_DATE,CURRENT_DATE)
		ON CONFLICT (id) DO UPDATE 
  		SET nombre = nombre_in, descripcion = descripcion_in, precio_unitario=precio_unitario_in,categoria='Insumo', fecha_actualizacion=CURRENT_DATE;
				
		INSERT INTO insumos (id_producto,fecha_caducidad,stock) 
		VALUES (id_in, fecha_caducidad_in, stock_in)
		ON CONFLICT (id_producto) DO UPDATE 
  		SET fecha_caducidad = fecha_caducidad_in, stock=stock_actual+stock_in;
		RETURN TRUE;
	ELSE 
		RETURN FALSE;
	END IF;
end;
$$ language plpgsql;


CREATE OR REPLACE FUNCTION create_or_update_instrumento(id_ins int8, nombre_ins varchar(255), descripcion_ins varchar(255),precio_unitario_ins float8, categoria_ins varchar(255), observacion_ins varchar(255), estado_ins enum_instrumentos_estado, stock_ins integer) RETURNS boolean AS
$$
DECLARE
	stock_actual integer:=0;
	exist_equipos integer:=0;
	exist_insumos integer:=0;
	sum_existen integer = 0;
BEGIN
	Select count(id_producto) INTO exist_equipos FROM equipos WHERE id_producto=id_ins;
	Select count(id_producto) INTO exist_insumos FROM insumos WHERE id_producto=id_ins;
	sum_existen:=exist_equipos+exist_insumos;
	IF sum_existen = 0 THEN
		SELECT stock INTO stock_actual FROM insumos WHERE id_producto = id_ins;
		INSERT INTO productos (id, nombre, descripcion, precio_unitario, categoria, fecha_creacion, fecha_actualizacion ) 
		VALUES (id_ins, nombre_ins, descripcion_ins, precio_unitario_ins, 'Instrumento',CURRENT_DATE,CURRENT_DATE)
		ON CONFLICT (id) DO UPDATE 
  		SET nombre = nombre_ins, descripcion = descripcion_ins, precio_unitario=precio_unitario_ins,categoria='Instrumento', fecha_actualizacion=CURRENT_DATE;
				
		INSERT INTO instrumentos (id_producto,observacion,estado,stock) 
		VALUES (id_ins,observacion_ins,estado_ins, stock_ins)
		ON CONFLICT (id_producto) DO UPDATE 
  		SET observacion=observacion_ins, estado=estado_ins,stock=stock_actual+stock_ins;
		RETURN TRUE;
	ELSE 
		RETURN FALSE;
	END IF;
end;
$$ language plpgsql;


SELECT create_or_update_insumo(12,'Nombre de insumos','Ninguna Descripción',10.89,'Insumo','2019-06-29',1);
SELECT create_or_update_equipo(14,'Cambio el nombre', 'Equipo','Ninguna Descripción',1089.99, 'Marca ','Ninguna Observación', 'Buen Estado',0);
SELECT create_or_update_instrumento(14, 'Nombre de instrumentos', 'Ninguna Descripción',10.8968, 'Instrumento', 'Ninguna Observación', 'Buen Estado', 10);

DROP FUNCTION create_or_update_equipo(bigint,character varying,character varying,character varying,double precision,character varying,character varying,enum_equipos_estado,integer);
DROP FUNCTION create_or_update_insumo(id_in int8, nombre_in varchar(255), descripcion_in varchar(255),precio_unitario_in float8, categoria_in varchar(255),fecha_caducidad_in date, stock_in integer);
DROP FUNCTION create_or_update_instrumento(id_ins int8, nombre_ins varchar(255), descripcion_ins varchar(255),precio_unitario_ins float8, categoria_ins varchar(255), observacion_ins varchar(255), estado_ins enum_instrumentos_estado, stock_ins integer);

SELECT * FROM productos;
SELECT * FROM equipos;
SELECT * FROM insumos;

